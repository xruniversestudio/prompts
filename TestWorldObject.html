<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebAR with Fallback (WebXR ➜ MindAR)</title>

  <!-- A-Frame (1.6.0) -->
  <script src="https://unpkg.com/aframe@1.6.0/dist/aframe.min.js"></script>

  <!-- MindAR (Image) + A-Frame plugin (لـ iOS/البديل) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    #ui {
      position: fixed; inset: 0;
      display: grid; grid-template-rows: auto 1fr auto; align-items: start;
      pointer-events: none;
    }
    #msg {
      margin: 12px; background: rgba(0,0,0,.55); color: #fff;
      padding: 10px 12px; border-radius: 10px; font: 500 14px/1.4 system-ui,sans-serif;
      backdrop-filter: blur(6px);
    }
    #startAR {
      pointer-events: auto;
      margin: 24px; padding: 14px 18px;
      font: 600 16px/1.1 system-ui, sans-serif;
      border: 0; border-radius: 14px;
      background: #00d18f; color: #00130e;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      transition: transform .08s ease, opacity .2s ease;
      justify-self: center; align-self: end;
    }
    #startAR:active { transform: scale(0.98); }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- UI Overlay (dom-overlay) -->
  <div id="ui">
    <div id="msg">اضغط “ابدأ الواقع المعزز” لفتح الكاميرا. سيختار الكود أفضل تقنية تلقائياً.</div>
    <div></div>
    <button id="startAR" type="button">ابدأ الواقع المعزز</button>
  </div>

  <!-- ========= مشهد WebXR (يُستخدم إن كان مدعومًا) ========= -->
  <a-scene id="webxrScene"
           class="hidden"
           embedded
           xr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false"
           renderer="antialias:true; physicallyCorrectLights:true; colorManagement:true"
           webxr="optionalFeatures: hit-test, dom-overlay, light-estimation; overlayElement: #ui">
    <!-- إضاءة أساسية (light-estimation سيحسنها إن توفر) -->
    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>

    <!-- كاميرا بدون look-controls لتجنب إذن DeviceOrientation -->
    <a-entity camera look-controls="enabled:false" wasd-controls="enabled:false"></a-entity>

    <!-- عنصر تجريبي أمام المستخدم للتأكد -->
    <a-box id="xrBox" position="0 0 -0.4" depth="0.1" height="0.1" width="0.1"
           color="#4cc3d9" visible="false"></a-box>
  </a-scene>

  <!-- ========= مشهد MindAR (Fallback — image marker) =========
       يستخدم ماركر Hiro القياسي.
       اطبع الماركر من: https://raw.githubusercontent.com/MindAR-js/marker-training/main/examples/targets/hiro.png
  -->
  <a-scene id="mindarScene"
           class="hidden"
           embedded
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false"
           mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/MindAR-js/marker-training/examples/targets/hiro.mind; uiLoading: no; uiScanning: no;">
    <!-- كاميرا MindAR -->
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- عند رؤية الماركر، يظهر هذا المجسم فوقه -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-box position="0 0 0" depth="0.5" height="0.5" width="0.5" color="#ffb703"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"></a-box>
      <a-text value="MindAR Fallback" align="center" position="0 -0.6 0" width="2"></a-text>
    </a-entity>
  </a-scene>

  <script>
    (function () {
      const ui = document.getElementById('ui');
      const msg = document.getElementById('msg');
      const startBtn = document.getElementById('startAR');
      const webxrScene = document.getElementById('webxrScene');
      const mindarScene = document.getElementById('mindarScene');
      const xrBox = document.getElementById('xrBox');

      let mode = null; // 'webxr' | 'mindar'

      function setMessage(t) { msg.textContent = t; }

      async function detectMode() {
        // تفضيل WebXR إن كان مدعومًا
        if ('xr' in navigator) {
          try {
            const ok = await navigator.xr.isSessionSupported('immersive-ar');
            if (ok) return 'webxr';
          } catch (e) { /* ignore */ }
        }
        // وإلا نعود لـ MindAR image
        return 'mindar';
      }

      // بدء WebXR
      async function startWebXR() {
        webxrScene.classList.remove('hidden');
        // A-Frame enterVR() يشغل جلسة WebXR AR
        await webxrScene.enterVR();
        xrBox.setAttribute('visible', true);
        setMessage('تم تشغيل كاميرا WebXR. حرّك الهاتف لتثبيت التتبع.');
      }

      // بدء MindAR
      async function startMindAR() {
        mindarScene.classList.remove('hidden');
        setMessage('افتح الكاميرا ووجّهها إلى ماركر Hiro لتظهر المجسّم.');
        // بدء نظام MindAR يدويًا
        try {
          await mindarScene.systems['mindar-image-system'].start(); // 🔹 يبدأ الكاميرا والتتبّع
        } catch (e) {
          console.error(e);
          setMessage('تعذّر تشغيل MindAR. تحقق من أذونات الكاميرا وجرّب إعادة التحميل.');
          throw e;
        }
      }

      // الضغط على زر البدء
      startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        setMessage('جاري التحقق من دعم الجهاز...');
        try {
          mode = await detectMode();
          if (mode === 'webxr') {
            await startWebXR();
          } else {
            await startMindAR();
          }
          startBtn.classList.add('hidden');
        } catch (e) {
          console.error(e);
          startBtn.disabled = false;
          setMessage('تعذّر البدء. تأكد من HTTPS ومنح إذن الكاميرا. على iOS استخدم الوضع الاحتياطي (MindAR).');
        }
      });

      // أحداث الدخول/الخروج من WebXR
      webxrScene.addEventListener('enter-vr', () => {
        xrBox.setAttribute('visible', true);
      });
      webxrScene.addEventListener('exit-vr', () => {
        xrBox.setAttribute('visible', false);
        startBtn.classList.remove('hidden');
        setMessage('انتهت جلسة AR. يمكنك البدء مجددًا.');
      });
    })();
  </script>
</body>
</html>
