<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebAR with Fallback (WebXR âœ MindAR)</title>

  <!-- A-Frame (1.6.0) -->
  <script src="https://unpkg.com/aframe@1.6.0/dist/aframe.min.js"></script>

  <!-- MindAR (Image) + A-Frame plugin (Ù„Ù€ iOS/Ø§Ù„Ø¨Ø¯ÙŠÙ„) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    #ui {
      position: fixed; inset: 0;
      display: grid; grid-template-rows: auto 1fr auto; align-items: start;
      pointer-events: none;
    }
    #msg {
      margin: 12px; background: rgba(0,0,0,.55); color: #fff;
      padding: 10px 12px; border-radius: 10px; font: 500 14px/1.4 system-ui,sans-serif;
      backdrop-filter: blur(6px);
    }
    #startAR {
      pointer-events: auto;
      margin: 24px; padding: 14px 18px;
      font: 600 16px/1.1 system-ui, sans-serif;
      border: 0; border-radius: 14px;
      background: #00d18f; color: #00130e;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      transition: transform .08s ease, opacity .2s ease;
      justify-self: center; align-self: end;
    }
    #startAR:active { transform: scale(0.98); }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- UI Overlay (dom-overlay) -->
  <div id="ui">
    <div id="msg">Ø§Ø¶ØºØ· â€œØ§Ø¨Ø¯Ø£ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²â€ Ù„ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø³ÙŠØ®ØªØ§Ø± Ø§Ù„ÙƒÙˆØ¯ Ø£ÙØ¶Ù„ ØªÙ‚Ù†ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
    <div></div>
    <button id="startAR" type="button">Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²</button>
  </div>

  <!-- ========= Ù…Ø´Ù‡Ø¯ WebXR (ÙŠÙØ³ØªØ®Ø¯Ù… Ø¥Ù† ÙƒØ§Ù† Ù…Ø¯Ø¹ÙˆÙ…Ù‹Ø§) ========= -->
  <a-scene id="webxrScene"
           class="hidden"
           embedded
           xr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false"
           renderer="antialias:true; physicallyCorrectLights:true; colorManagement:true"
           webxr="optionalFeatures: hit-test, dom-overlay, light-estimation; overlayElement: #ui">
    <!-- Ø¥Ø¶Ø§Ø¡Ø© Ø£Ø³Ø§Ø³ÙŠØ© (light-estimation Ø³ÙŠØ­Ø³Ù†Ù‡Ø§ Ø¥Ù† ØªÙˆÙØ±) -->
    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>

    <!-- ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¯ÙˆÙ† look-controls Ù„ØªØ¬Ù†Ø¨ Ø¥Ø°Ù† DeviceOrientation -->
    <a-entity camera look-controls="enabled:false" wasd-controls="enabled:false"></a-entity>

    <!-- Ø¹Ù†ØµØ± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø£Ù…Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ£ÙƒØ¯ -->
    <a-box id="xrBox" position="0 0 -0.4" depth="0.1" height="0.1" width="0.1"
           color="#4cc3d9" visible="false"></a-box>
  </a-scene>

  <!-- ========= Ù…Ø´Ù‡Ø¯ MindAR (Fallback â€” image marker) =========
       ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø§Ø±ÙƒØ± Hiro Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ.
       Ø§Ø·Ø¨Ø¹ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ù…Ù†: https://raw.githubusercontent.com/MindAR-js/marker-training/main/examples/targets/hiro.png
  -->
  <a-scene id="mindarScene"
           class="hidden"
           embedded
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false"
           mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/MindAR-js/marker-training/examples/targets/hiro.mind; uiLoading: no; uiScanning: no;">
    <!-- ÙƒØ§Ù…ÙŠØ±Ø§ MindAR -->
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- Ø¹Ù†Ø¯ Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø§Ø±ÙƒØ±ØŒ ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ø³Ù… ÙÙˆÙ‚Ù‡ -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-box position="0 0 0" depth="0.5" height="0.5" width="0.5" color="#ffb703"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"></a-box>
      <a-text value="MindAR Fallback" align="center" position="0 -0.6 0" width="2"></a-text>
    </a-entity>
  </a-scene>

  <script>
    (function () {
      const ui = document.getElementById('ui');
      const msg = document.getElementById('msg');
      const startBtn = document.getElementById('startAR');
      const webxrScene = document.getElementById('webxrScene');
      const mindarScene = document.getElementById('mindarScene');
      const xrBox = document.getElementById('xrBox');

      let mode = null; // 'webxr' | 'mindar'

      function setMessage(t) { msg.textContent = t; }

      async function detectMode() {
        // ØªÙØ¶ÙŠÙ„ WebXR Ø¥Ù† ÙƒØ§Ù† Ù…Ø¯Ø¹ÙˆÙ…Ù‹Ø§
        if ('xr' in navigator) {
          try {
            const ok = await navigator.xr.isSessionSupported('immersive-ar');
            if (ok) return 'webxr';
          } catch (e) { /* ignore */ }
        }
        // ÙˆØ¥Ù„Ø§ Ù†Ø¹ÙˆØ¯ Ù„Ù€ MindAR image
        return 'mindar';
      }

      // Ø¨Ø¯Ø¡ WebXR
      async function startWebXR() {
        webxrScene.classList.remove('hidden');
        // A-Frame enterVR() ÙŠØ´ØºÙ„ Ø¬Ù„Ø³Ø© WebXR AR
        await webxrScene.enterVR();
        xrBox.setAttribute('visible', true);
        setMessage('ØªÙ… ØªØ´ØºÙŠÙ„ ÙƒØ§Ù…ÙŠØ±Ø§ WebXR. Ø­Ø±Ù‘Ùƒ Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØªØ¨Ø¹.');
      }

      // Ø¨Ø¯Ø¡ MindAR
      async function startMindAR() {
        mindarScene.classList.remove('hidden');
        setMessage('Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙˆØ¬Ù‘Ù‡Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ø§Ø±ÙƒØ± Hiro Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø¬Ø³Ù‘Ù….');
        // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… MindAR ÙŠØ¯ÙˆÙŠÙ‹Ø§
        try {
          await mindarScene.systems['mindar-image-system'].start(); // ğŸ”¹ ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØªØªØ¨Ù‘Ø¹
        } catch (e) {
          console.error(e);
          setMessage('ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ MindAR. ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„.');
          throw e;
        }
      }

      // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
      startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        setMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²...');
        try {
          mode = await detectMode();
          if (mode === 'webxr') {
            await startWebXR();
          } else {
            await startMindAR();
          }
          startBtn.classList.add('hidden');
        } catch (e) {
          console.error(e);
          startBtn.disabled = false;
          setMessage('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¨Ø¯Ø¡. ØªØ£ÙƒØ¯ Ù…Ù† HTTPS ÙˆÙ…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø¹Ù„Ù‰ iOS Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (MindAR).');
        }
      });

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† WebXR
      webxrScene.addEventListener('enter-vr', () => {
        xrBox.setAttribute('visible', true);
      });
      webxrScene.addEventListener('exit-vr', () => {
        xrBox.setAttribute('visible', false);
        startBtn.classList.remove('hidden');
        setMessage('Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© AR. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');
      });
    })();
  </script>
</body>
</html>
